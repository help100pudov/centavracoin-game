import{t as x,g as T}from"./tonconnect-0a311c7b.js";import{_ as f,o as l,c,a as s,F as _,r as v,n as u,t as e,b as p,u as C,s as g,d as k}from"./index-f7d62f39.js";import b from"./walletcenta-ae3cf4d9.js";const H={name:"PaymentProgress",props:{currentStep:{type:Number,default:0},statusMessage:{type:String,default:""},statusType:{type:String,default:"pending"},txHash:{type:String,default:""}},computed:{steps(){return[{label:"Ожидание оплаты",type:"pending"},{label:"Платёж отправлен",type:"pending"},{label:"Платёж подтверждён",type:"success"},{label:"Ошибка",type:"error"}]},statusClass(){return{"alert-success":this.statusType==="success","alert-pending":this.statusType==="pending","alert-error":this.statusType==="error"}},shortHash(){return this.txHash?this.txHash.slice(0,8)+"..."+this.txHash.slice(-8):""}},methods:{copyHash(){this.txHash&&(navigator.clipboard.writeText(this.txHash),this.$emit("copied",this.txHash))}}},P={class:"payment-progress"},$={class:"steps"},w={key:0},U={key:1},I={class:"label"},S={key:0,class:"line"},D={key:1,class:"tx-hash"},A={class:"hash"};function N(t,n,d,m,i,r){return l(),c("div",P,[s("div",$,[(l(!0),c(_,null,v(r.steps,(o,h)=>(l(),c("div",{key:h,class:"step"},[s("div",{class:u(["circle",{active:h<=d.currentStep,error:o.type==="error"&&d.currentStep===h}])},[o.type==="error"&&d.currentStep===h?(l(),c("span",w,"!")):(l(),c("span",U,e(h+1),1))],2),s("div",I,e(o.label),1),h<r.steps.length-1?(l(),c("div",S)):p("",!0)]))),128))]),d.statusMessage?(l(),c("div",{key:0,class:u(["status-message",r.statusClass])},e(d.statusMessage),3)):p("",!0),d.txHash?(l(),c("div",D,[n[1]||(n[1]=s("span",null,"txHash:",-1)),s("span",A,e(r.shortHash),1),s("button",{onClick:n[0]||(n[0]=(...o)=>r.copyHash&&r.copyHash(...o))},"Копировать")])):p("",!0)])}const E=f(H,[["render",N],["__scopeId","data-v-2106a464"]]);const M={name:"Top",mixins:[x],components:{PaymentProgress:E},setup(){return{toast:C()}},data(){return{tonConnectUI:null,isConnected:!1,walletAddress:"",tonAmount:1,status:"",statusType:"pending",paymentStep:0,txHash:"",lastTxPayload:null,isChecking:!1,paymentPolling:!1,pollingTries:0,pollingMax:6,pollingInterval:null,pollingTimer:60,pollingCountdown:null,paymentStatus:"",paymentSuccess:!1,paymentError:""}},created(){try{this.tonConnectUI=T(),this.tonConnectUI.onStatusChange(t=>{var n;this.isConnected=!!t,this.walletAddress=((n=t==null?void 0:t.account)==null?void 0:n.address)||"",console.log("Wallet status changed:",t)})}catch(t){console.error("Ошибка инициализации TonConnectUI:",t),this.status=this.$t("TonConnectUI initialization error:")+t.message,this.toast.error(this.$t("TonConnectUI initialization error"),{timeout:3e3})}},mounted(){this.$store.dispatch("fetchUserData")},methods:{onHashCopied(t){this.toast.success(this.$t("txHash copied!"),{timeout:2e3})},copyTxHash(){this.txHash&&(navigator.clipboard.writeText(this.txHash),this.toast.success(this.$t("txHash copied!"),{timeout:2e3}))},async connectWallet(){if(!this.tonConnectUI){this.status=this.$t("Connection not initialized error"),this.toast.error(this.$t("Connection not initialized error"),{timeout:3e3});return}try{await this.tonConnectUI.connectWallet(),this.status=this.$t("Wallet connected!"),this.toast.success(this.$t("Wallet connected!"),{timeout:3e3}),await this.$store.dispatch("fetchUserData")}catch(t){console.error("Ошибка подключения:",t),this.status=this.$t("Connection error:")+t.message,this.toast.error(this.$t("Connection error"),{timeout:3e3})}},startPollingUserData(){this.pollingInterval&&clearInterval(this.pollingInterval),this.pollingInterval=setInterval(()=>{this.$store.dispatch("fetchUserData")},3e3)},stopPollingUserData(){this.pollingInterval&&clearInterval(this.pollingInterval)},async sendPayment(){var m,i,r;if(console.log("sendPayment called"),!this.tonConnectUI){this.status=this.$t("Connection not initialized error"),this.toast.error(this.$t("Connection not initialized error"),{timeout:3e3});return}let t=(m=this.$store.state.user)==null?void 0:m.chat;if(!t&&typeof this.getTelegramUser=="function"){const o=this.getTelegramUser();t=o==null?void 0:o.id}if(console.log("chat:",t),!t){this.status=this.$t("Telegram ID not found error"),this.toast.error(this.$t("Telegram ID not found error"),{timeout:5e3});return}const n=1,d={validUntil:Math.floor(Date.now()/1e3)+360,messages:[{address:"UQA_2riTM3_ZP6LwrUld_XgEw4Q389-Sr1kuB6OE1JVfOcMo",amount:(n*1e9).toString()}]};this.paymentStep=1,this.statusType="pending",this.txHash="";try{const o=await this.tonConnectUI.sendTransaction(d);console.log("sendTransaction result:",o),this.status=this.$t("Payment sent! Hash:")+(o.boc||o.hash||o.txid||((i=o.transaction)==null?void 0:i.id)),this.statusType="pending",this.paymentStep=2;let h=((r=o.transaction)==null?void 0:r.id)||o.txid||o.hash||o.boc;if(this.txHash=h,console.log("txHash to send:",h),!h){this.toast.error(this.$t("Error: could not get txid or boc from TonConnect result!"),{timeout:5e3});return}const a=await g.post("/api/verify-ton-payment",{txHash:h,userAddress:this.walletAddress,amount:n,chat:t,product:"top_unlock_name",centaAmount:1});console.log("Backend response:",a.data),a.data&&a.data.txHash&&(this.txHash=a.data.txHash),a.data&&a.data.txUrl&&(this.txUrl=a.data.txUrl),this.status=a.data.message||this.$t("Payment sent and awaiting confirmation!"),this.statusType=a.data.success?"success":"pending",this.paymentStep=a.data.success?3:2,this.startPollingUserData(),a.data.success&&(this.stopPollingUserData(),await this.$store.dispatch("fetchUserData"))}catch(o){console.error("Ошибка платежа:",o),this.status=this.$t("Payment error:")+o.message,this.statusType="error",this.paymentStep=3,this.toast.error(this.$t("Payment error"),{timeout:3e3})}},async checkPayment(){if(this.lastTxPayload){this.status=this.$t("Checking payment...");try{const t=await g.post("/api/verify-ton-payment",this.lastTxPayload,{timeout:9e4});if(t.data.code==="TX_PENDING"&&t.data.userMessage){this.status=t.data.userMessage,this.statusType="pending",this.paymentStep=2,this.toast.info(t.data.userMessage,{timeout:1e4});return}this.status=t.data.message||this.$t("Payment successfully verified"),this.statusType="success",this.paymentStep=2,this.toast.success(this.$t("Payment verified!"),{timeout:3e3}),this.isChecking=!1}catch{this.status=this.$t("Payment check error"),this.statusType="error",this.paymentStep=3,this.toast.error(this.$t("Payment check error"),{timeout:3e3})}}}},beforeUnmount(){this.stopPollingUserData()}},B={class:"p-1 pl-4 pr-4"},W={class:"text-center bg-gradient-to-b from-yellow-500 to-yellow-700 py-6 rounded-xl shadow-xl mb-6"},z={class:"text-2xl font-bold text-white"},O={class:"text-blue-200 text-md mt-1"},V={class:"mt-4 max-w-sm mx-auto"},Y={class:"payment-steps-grid mb-3"},F={key:1,class:"tx-block mt-2"},L={class:"tx-value"},Q={class:"tx-short"},X={class:"tx-link mt-1"},G=["href"],J={class:"text-center text-up mt-3"},R={class:"card p-3 mt-2"},Z={class:"card flexBetween mt-2 p-1 pl-4 pr-4"},j={class:"flexCenter"},q={class:"ml-3"},K={class:"fs-14px"},tt={class:"fs-14px"},st={class:""},et={key:0,class:"card p-3 mt-5"},nt={class:""},at={class:"d-flex items-center w-80"},ot={class:"flexCenter"},it={class:"ml-3"},rt={class:"fs-16px fw-700"},lt={class:"d-flex items-center fs-14px"},ct={class:""},ht={key:1,class:"card text-center p-4 mt-4"};function dt(t,n,d,m,i,r){var o,h;return l(),c("div",B,[s("div",W,[n[5]||(n[5]=s("img",{src:b,alt:"Wallet CENTA",class:"w-20 mx-auto mb-2"},null,-1)),s("h2",z,e(t.$t("BUY CENTA")),1),s("p",O,e(t.$t("Unlock your name & move up in the ranking")),1),s("div",V,[s("div",Y,[s("div",{class:u(["step",{active:i.paymentStep>=1}])},e(t.$t("Enter amount")),3),s("div",{class:u(["step",{active:i.paymentStep>=2}])},e(t.$t("Payment sent")),3),s("div",{class:u(["step",{active:i.paymentStep>=3}])},e(t.$t("Payment confirmed")),3),s("div",{class:u(["step",{error:i.statusType==="error"}])},e(t.$t("Error")),3)]),i.status?(l(),c("div",{key:0,class:u(["status-message",i.statusType])},e(t.$t(i.status)),3)):p("",!0),i.txHash&&i.statusType!=="pending"?(l(),c("div",F,[n[4]||(n[4]=s("div",{class:"tx-label"},"txHash:",-1)),s("div",L,[s("span",Q,e(i.txHash.slice(0,6)+"..."+i.txHash.slice(-6)),1),s("button",{class:"copy-btn ml-2",onClick:n[0]||(n[0]=(...a)=>r.copyTxHash&&r.copyTxHash(...a))},e(t.$t("Copy")),1)]),s("div",X,[s("a",{href:`https://tonviewer.com/transaction/${i.txHash}`,target:"_blank",rel:"noopener"},e(t.$t("Open in TonViewer")),9,G)])])):p("",!0),i.isConnected?(l(),c("button",{key:3,onClick:n[2]||(n[2]=(...a)=>r.sendPayment&&r.sendPayment(...a)),class:"top-payment-btn w-full text-white font-bold py-3 px-6 rounded-lg shadow-xl transition-all duration-300"}," 🚀 "+e(t.$t("Buy 1 CENTA for"))+" "+e(i.tonAmount)+" TON ",1)):(l(),c("button",{key:2,onClick:n[1]||(n[1]=(...a)=>r.connectWallet&&r.connectWallet(...a)),class:"top-connect-wallet-btn w-full text-white font-bold py-3 px-6 rounded-lg shadow-xl transition-all duration-300"},e(t.$t("Connect TON wallet")),1)),i.isChecking?(l(),c("button",{key:4,onClick:n[3]||(n[3]=(...a)=>r.checkPayment&&r.checkPayment(...a)),class:"top-payment-btn mt-2"},e(t.$t("Check payment")),1)):p("",!0)])]),n[8]||(n[8]=s("div",{class:"text-center"},[s("i",{class:"icon i-top x50"})],-1)),s("h4",J,e(t.$t("Top participants")),1),s("div",R,[s("h5",null,e(t.$t("Your place")),1),s("div",Z,[s("div",j,[s("div",null,[s("i",{class:u(["icon x40 br-50",`i-ava${t.user.ava}`])},null,2)]),s("div",q,[s("h6",K,e(t.user.first.slice(0,8))+" "+e(t.user.last.charAt(0)),1),s("div",tt,[n[6]||(n[6]=s("i",{class:"icon x14 i-centa"},null,-1)),k(" "+e(t.$num(t.user.centa)),1)])])]),s("h6",st,e((o=t.app.top)==null?void 0:o.centaYou),1)])]),(h=t.app.top)!=null&&h.centa?(l(),c("div",et,[s("h4",nt,e(t.$t("Top 100 players")),1),(l(!0),c(_,null,v(t.app.top.centa,(a,y)=>(l(),c("div",{class:"card p-1 pl-4 pr-4 mt-1 flexBetween",key:y},[s("div",at,[s("div",ot,[s("div",null,[s("i",{class:u(["icon x40 br-50",`i-ava${a.ava}`])},null,2)]),s("div",it,[s("div",rt,e(a==null?void 0:a.first.slice(0,8))+" "+e(a.last.charAt(0)),1),s("div",lt,[n[7]||(n[7]=s("i",{class:"icon i-centa x16 mr-1"},null,-1)),s("div",null,e(t.$num(a.centa)),1)])])])]),s("div",null,[s("h6",ct,"#"+e(y+1),1)])]))),128))])):(l(),c("div",ht,e(t.$t("Not found")),1))])}const yt=f(M,[["render",dt],["__scopeId","data-v-3e043564"]]);export{yt as default};
